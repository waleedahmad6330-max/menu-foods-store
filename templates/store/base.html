{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organically</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.3/viewer.min.css">

    <style>
        :root { --primary-green: #006837; --accent-yellow: #fecb00; --light-bg: #f8f9fa; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-bg); display: flex; flex-direction: column; min-height: 100vh; }
        
        .top-bar { background-color: #000; color: #fff; font-size: 0.75rem; padding: 8px 0; overflow: hidden; white-space: nowrap; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .main-header { background-color: #fff; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .search-input { border-radius: 50px; padding-right: 40px; border: 1px solid #ddd; }
        .search-btn { position: absolute; right: 5px; top: 2px; background: none; border: none; color: var(--primary-green); }
        
        .navbar-custom .nav-link { color: #333; font-weight: 600; font-size: 0.85rem; padding: 15px 15px; transition: 0.3s; }
        .navbar-custom .nav-link:hover { color: var(--primary-green); }
        
        .dropdown-menu { border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-radius: 8px; }
        .dropdown-item { font-size: 0.9rem; padding: 8px 20px; font-weight: 500; }
        .dropdown-item:hover { background-color: #f0fdf4; color: var(--primary-green); }

        /* --- DESKTOP HOVER DROPDOWN --- */
        @media (min-width: 992px) {
            .navbar-custom .dropdown:hover > .dropdown-menu {
                display: block;
                margin-top: 0; 
            }
            .navbar-custom .dropdown-toggle::after {
                vertical-align: middle;
                margin-left: 5px;
            }
        }

        .message-container { position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; display: flex; flex-direction: column; gap: 10px; }
        .custom-alert { background: white; border-left: 5px solid; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border-radius: 8px; padding: 15px 20px; display: flex; align-items: center; animation: slideIn 0.5s ease-out forwards; border-color: #006837; }
        .alert-error { border-color: #dc3545; }
        .alert-info { border-color: #0dcaf0; }
        .alert-icon { font-size: 1.5rem; margin-right: 15px; color: #006837; }
        .alert-error .alert-icon { color: #dc3545; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }

        footer { background-color: #111; color: #bbb; margin-top: auto; padding-top: 70px; font-size: 0.9rem; }
        footer h5 { color: #fff; font-weight: 700; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.5px; }
        footer ul { list-style: none; padding: 0; }
        footer ul li { margin-bottom: 12px; }
        footer ul li a { color: #bbb; text-decoration: none; transition: 0.3s; }
        footer ul li a:hover { color: var(--accent-yellow); padding-left: 5px; }
        .footer-social { display: flex; gap: 10px; margin-top: 20px; }
        .footer-social a { display: flex; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); color: #fff !important; align-items: center; justify-content: center; border-radius: 50%; text-decoration: none; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); }
        .footer-social a:hover { background: var(--primary-green); border-color: var(--primary-green); transform: translateY(-3px); color: #fff !important; }
        .footer-bottom { background: #000; padding: 20px 0; margin-top: 50px; border-top: 1px solid #222; }

        @media (max-width: 991px) { 
            .top-bar { display: none; } .main-header { padding: 10px 0; } footer { text-align: center; padding-top: 40px; } 
            .footer-social { justify-content: center; margin-bottom: 30px; } .d-flex.align-items-center { justify-content: center; } 
            .mobile-actions { gap: 15px !important; }
            .btn-menu-toggle { background: none; border: none; font-size: 1.5rem; color: #333; }
        }
        .offcanvas-header { background-color: #006837; color: white; }
        .btn-close-white { filter: invert(1); }
        .sidebar-link { display: block; padding: 12px 20px; color: #333; text-decoration: none; font-weight: 600; border-bottom: 1px solid #f0f0f0; }
        .sidebar-link:hover { background-color: #f8f9fa; color: #006837; padding-left: 25px; transition: 0.3s; }
        .sub-link { padding-left: 40px; font-size: 0.85rem; color: #555; background-color: #fcfcfc; }
    </style>
</head>
<body>

    <div class="message-container" id="toast-container">
        {% if messages %}
            {% for message in messages %}
            <div class="custom-alert alert-{{ message.tags }}">
                <div class="alert-icon">{% if message.tags == 'error' %}<i class="fas fa-exclamation-circle"></i>{% else %}<i class="fas fa-check-circle"></i>{% endif %}</div>
                <div><strong class="d-block text-uppercase small text-muted" style="font-size: 0.7rem;">Notification</strong><span class="text-dark small fw-bold">{{ message }}</span></div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="top-bar"><div class="marquee-text">Whatsapp us 24/7 at +92 322-7554426 | Free Delivery for Orders over 2500 </div></div>

    <div class="main-header sticky-top">
        <div class="container">
            <div class="row align-items-center g-2">
                <div class="col-6 col-lg-3 d-flex align-items-center">
                    <button class="btn-menu-toggle d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar"><i class="fas fa-bars"></i></button>
                    <a href="{% url 'home' %}" class="text-decoration-none"><h4 class="m-0 fw-bold" style="color: var(--primary-green);">Organically</h4></a>
                </div>
                <div class="col-6 col-lg-3 text-end d-flex align-items-center justify-content-end order-lg-3 mobile-actions gap-3">
                    {% if user.is_authenticated %}
                        <div class="dropdown">
                            <a class="text-dark text-decoration-none small fw-bold dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle fa-lg text-success me-1"></i>
                                <span class="d-none d-lg-inline">{{ user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0" style="z-index: 1050;">
                                <li><span class="dropdown-item-text small text-muted">Hi, {{ user.username }}</span></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item small" href="{% url 'my_orders' %}">My Orders</a></li>
                                {% if user.is_superuser %}<li><a class="dropdown-item small text-primary" href="{% url 'admin_dashboard' %}">Admin Panel</a></li>{% endif %}
                                <li><a class="dropdown-item small text-danger" href="{% url 'logout' %}">Logout</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{% url 'login' %}" class="text-dark small fw-bold"><i class="fas fa-user me-1"></i> Login</a>
                    {% endif %}
                    <a href="{% url 'cart_page' %}" class="btn btn-outline-success rounded-pill position-relative border-0 fw-bold p-1 px-2">
                        <i class="fas fa-shopping-basket fa-lg"></i>
                        <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">{{ cart_item_count|default:"0" }}</span>
                    </a>
                </div>
                <div class="col-12 col-lg-6 order-lg-2 mt-2 mt-lg-0">
                    <form class="search-box d-flex position-relative" action="{% url 'search' %}" method="GET">
                        <input class="form-control search-input" type="search" name="q" placeholder="Search products..." value="{{ request.GET.q }}">
                        <button class="search-btn" type="submit"><i class="fas fa-search"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- DESKTOP NAVIGATION -->
    <nav class="navbar navbar-expand-lg navbar-custom shadow-sm bg-white d-none d-lg-block">
        <div class="container justify-content-center">
            <ul class="navbar-nav align-items-center">
                <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">HOME</a></li>
                
                {% for cat in categories %}
                    {% if not cat.parents.exists %}
                        {% if cat.children.exists %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="{% url 'category_view' cat.id %}" id="catDrop{{ cat.id }}" role="button" aria-expanded="false">
                                    {{ cat.name|upper }}
                                </a>
                                <ul class="dropdown-menu text-center text-lg-start shadow border-0">
                                    <li><a class="dropdown-item fw-bold" href="{% url 'category_view' cat.id %}">All {{ cat.name }}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% for child in cat.children.all %}
                                        <li><a class="dropdown-item" href="{% url 'category_view' child.id %}">{{ child.name|title }}</a></li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'category_view' cat.id %}">{{ cat.name|upper }}</a>
                            </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <li class="nav-item"><a class="nav-link" href="{% url 'about' %}">ABOUT US</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'membership' %}">MEMBERSHIP</a></li>
            </ul>
        </div>
    </nav>

    <!-- MOBILE SIDEBAR -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
        <div class="offcanvas-header"><h5 class="offcanvas-title text-white">Organically</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
        <div class="offcanvas-body p-0">
            <div class="list-group list-group-flush">
                <a href="{% url 'home' %}" class="sidebar-link"><i class="fas fa-home me-2"></i> Home</a>
                <a href="{% url 'about' %}" class="sidebar-link"><i class="fas fa-info-circle me-2"></i> About Us</a>
                <a href="{% url 'membership' %}" class="sidebar-link"><i class="fas fa-crown text-warning me-2"></i> Membership Club</a>
                
                <div class="bg-light p-2 ps-3 text-muted small fw-bold text-uppercase mt-2">Categories</div>
                {% for cat in categories %}
                    {% if not cat.parents.exists %}
                        {% if cat.children.exists %}
                            <div class="sidebar-link fw-bold text-success d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#mobCat{{ cat.id }}" role="button" aria-expanded="false">
                                {{ cat.name|title }} <i class="fas fa-chevron-down small"></i>
                            </div>
                            <div class="collapse" id="mobCat{{ cat.id }}">
                                <a href="{% url 'category_view' cat.id %}" class="sidebar-link ps-5 text-dark fw-bold" style="font-size: 0.85rem;">All {{ cat.name }}</a>
                                {% for child in cat.children.all %}
                                    <a href="{% url 'category_view' child.id %}" class="sidebar-link sub-link">- {{ child.name|title }}</a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <a href="{% url 'category_view' cat.id %}" class="sidebar-link ps-4"> {{ cat.name|title }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                <div class="bg-light p-2 ps-3 text-muted small fw-bold text-uppercase mt-2">Account</div>
                {% if user.is_authenticated %}
                    <a href="{% url 'my_orders' %}" class="sidebar-link"><i class="fas fa-box me-2"></i> My Orders</a>
                    <a href="{% url 'logout' %}" class="sidebar-link text-danger"><i class="fas fa-sign-out-alt me-2 text-danger"></i> Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="sidebar-link"><i class="fas fa-sign-in-alt me-2"></i> Login / Signup</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div style="flex: 1;">{% block content %}{% endblock %}</div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-4 col-md-6">
                    <h5 class="text-white">Brand Story</h5>
                    <p class="small mb-4" style="color: var(--accent-white); text-align: justify;">
                        When our salon clients came to us with damaged hair and tired, stressed skin, we knew they deserved something better.
                        Their struggles inspired us to create safe, effective, and affordable products they could truly rely on.
                    </p>
                </div>
                <div class="col-lg-2 col-md-6 col-6"><h5>Links</h5><ul><li><a href="{% url 'home' %}">Home</a></li><li><a href="{% url 'membership' %}">Membership</a></li><li><a href="{% url 'cart_page' %}">Cart</a></li></ul></div>
                <div class="col-lg-2 col-md-6 col-6"><h5>Support</h5><ul><li><a href="{% url 'my_orders' %}">Tracking</a></li></ul></div>
                <div class="col-lg-4 col-md-6">
                    <h5>Need Help?</h5>
                    <p class="small mb-3" style="color: var(--accent-yellow);">Chat with us on WhatsApp.</p>
                    <a href="https://wa.me/923227554426" target="_blank" class="btn w-100 mb-3 d-flex align-items-center justify-content-center" style="background-color: #25D366; color: white; font-weight: bold; border:none; padding: 12px; border-radius: 8px;"><i class="fab fa-whatsapp fa-lg me-2"></i> Chat on WhatsApp</a>
                    <div class="d-flex align-items-center mb-3"><i class="fas fa-headset fa-2x text-success me-3"></i><div><p class="mb-0 small" style="color: var(--accent-yellow);">Call us 24/7</p><h6 class="text-white fw-bold m-0">+92 322-7554426</h6></div></div>
                    <div class="footer-social"><a href="https://web.facebook.com/profile.php?id=61584493205748" target="_blank"><i class="fab fa-facebook-f"></i></a><a href="#" target="_blank"><i class="fab fa-instagram"></i></a></div>
                </div>
            </div>
        </div>
        <div class="footer-bottom"><div class="container text-center"><p class="mb-0 small text-white">&copy; 2025 Organically.</p></div></div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.3/viewer.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form[action*="add-to-cart"]');
            
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    
                    const submitter = e.submitter;
                    
                    // --- BUY NOW LOGIC (AJAX + REDIRECT) ---
                    if (submitter && submitter.value === 'buy_now') {
                        e.preventDefault(); // Prevent standard POST initially
                        
                        const url = this.action;
                        const csrf = this.querySelector('input[name="csrfmiddlewaretoken"]').value;
                        const originalText = submitter.innerHTML;
                        
                        // Collect Quantity
                        const qtyInput = this.querySelector('input[name="quantity"]');
                        const quantity = qtyInput ? qtyInput.value : 1;
                        
                        const formData = new FormData();
                        formData.append('quantity', quantity);
                        // No action=buy_now sent, so backend treats as standard AJAX add
                        
                        // Loading State
                        submitter.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                        submitter.disabled = true;
                        
                        // 1. Send AJAX Request
                        fetch(url, { 
                            method: 'POST', 
                            headers: { 
                                'X-CSRFToken': csrf, 
                                'X-Requested-With': 'XMLHttpRequest' 
                            },
                            body: formData 
                        })
                        .then(response => response.json())
                        .then(data => { 
                            if (data.status === 'success') {
                                // 2. If success, Redirect to Cart
                                window.location.href = "{% url 'cart_page' %}";
                            } else if(data.status === 'error') {
                                showToast(data.message); // Show Stock Error
                                submitter.innerHTML = originalText;
                                submitter.disabled = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            submitter.innerHTML = originalText;
                            submitter.disabled = false;
                        });
                        
                        return; // Stop here, don't execute standard add to cart logic below
                    }
                    
                    // --- STANDARD ADD TO CART (AJAX ONLY) ---
                    e.preventDefault();
                    
                    const url = this.action;
                    const csrf = this.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    const btn = submitter || this.querySelector('button[type="submit"]'); 
                    const originalText = btn.innerHTML;
                    
                    const qtyInput = this.querySelector('input[name="quantity"]');
                    const quantity = qtyInput ? qtyInput.value : 1;

                    const formData = new FormData();
                    formData.append('quantity', quantity);
                    
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                    btn.disabled = true;
                    
                    fetch(url, { 
                        method: 'POST', 
                        headers: { 
                            'X-CSRFToken': csrf, 
                            'X-Requested-With': 'XMLHttpRequest' 
                        },
                        body: formData 
                    })
                    .then(response => response.json())
                    .then(data => { 
                        if (data.status === 'success') { 
                            document.getElementById('cart-badge').textContent = data.cart_count; 
                            showToast(data.message); 
                        } else if(data.status === 'error') {
                            showToast(data.message); 
                        }
                    })
                    .catch(error => console.error('Error:', error))
                    .finally(() => { 
                        btn.innerHTML = originalText; 
                        btn.disabled = false; 
                    });
                });
            });
        });

        function showToast(message) {
            const container = document.getElementById('toast-container');
            if(!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'custom-alert alert-success';
            toast.innerHTML = `<div class="alert-icon"><i class="fas fa-check-circle"></i></div><div><strong class="d-block text-uppercase small text-muted" style="font-size: 0.7rem;">Notification</strong><span class="text-dark small fw-bold">${message}</span></div>`;
            
            container.appendChild(toast);
            
            setTimeout(() => { 
                toast.style.animation = 'fadeOut 0.5s ease-out forwards'; 
                setTimeout(() => toast.remove(), 500); 
            }, 3000);
        }
        
        setTimeout(function() { 
            let alerts = document.querySelectorAll('.custom-alert'); 
            alerts.forEach(function(alert) { 
                alert.style.animation = 'fadeOut 0.5s ease-out forwards'; 
                setTimeout(() => { alert.remove(); }, 500); 
            }); 
        }, 4000);
        
        window.addEventListener('load', function() { 
            const gallery = document.getElementById('product-gallery'); 
            if (gallery) { new Viewer(gallery, { toolbar: 0, navbar: 0, title: 0, movable: 1, zoomable: 1 }); } 
        });
    </script>
</body>
</html>